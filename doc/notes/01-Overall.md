## æ€»è§ˆ

### Vue3 çš„åŸºæœ¬ç»“æ„

é‡‡ç”¨ Monorepo æ¨¡å¼(å¤šç»„ä»¶æ”¾åœ¨ä¸€ä¸ª Repo ä¸­), åœ¨ `/packages/` ä¸­å­˜å‚¨æ‰€æœ‰çš„æ¨¡å—.

**æ¨¡å—åˆ†ä¸ºå‡ ç±»:**

- ç¼–è¯‘æ—¶(`/package/compiler-*`)
  - `compiler-core`: ä¸å¹³å°æ— å…³çš„ç¼–è¯‘å™¨æ ¸å¿ƒ
  - `compiler-dom`: åŸºäº `compiler-core` è§£æ `<template>` æ ‡ç­¾å¹¶ç¼–è¯‘ä¸º render å‡½æ•°
  - `compiler-sfc`: åŸºäº `compiler-dom` ä¸ `compiler-core` è§£æ SFC (å•æ–‡ä»¶ç»„ä»¶, é€šä¿—ç†è§£å°±æ˜¯ `.vue` æ–‡ä»¶) ç¼–è¯‘ä¸ºæµè§ˆå™¨å¯æ‰§è¡Œçš„ JavaScript
  - `compiler-ssr`: æœåŠ¡ç«¯æ¸²æŸ“çš„ç¼–è¯‘æ¨¡å—
- è¿è¡Œæ—¶(`/package/runtime-*`)
  - `reactivity`: å®ç°å“åº”å¼
  - `runtime-core`: åŸºäº `reactivity` å®ç°è¿è¡Œæ—¶æ ¸å¿ƒ
  - `runtime-dom`: åŸºäº `runtime-core` å®ç°é’ˆå¯¹æµè§ˆå™¨çš„è¿è¡Œæ—¶. åŒ…æ‹¬DOM API, å±æ€§, äº‹ä»¶å¤„ç†ç­‰

- å…¶ä»–
  - `template-explorer`: ç”¨äºè°ƒè¯•ç¼–è¯‘å™¨è¾“å‡ºçš„å¼€å‘å·¥å…·
  - `shared`: å¤šä¸ªåŒ…ä¹‹é—´å…±äº«çš„å†…å®¹
  - `vue`: å®Œæ•´ç‰ˆæœ¬,åŒ…æ‹¬è¿è¡Œæ—¶å’Œç¼–è¯‘å™¨


**ä¾èµ–å…³ç³»**

```
                                    +---------------------+
                                    |                     |
                                    |  @vue/compiler-sfc  |
                                    |                     |
                                    +-----+--------+------+
                                          |        |
                                          v        v
                      +---------------------+    +----------------------+
                      |                     |    |                      |
        +------------>|  @vue/compiler-dom  +--->|  @vue/compiler-core  |
        |             |                     |    |                      |
   +----+----+        +---------------------+    +----------------------+
   |         |
   |   vue   |
   |         |
   +----+----+        +---------------------+    +----------------------+    +-------------------+
        |             |                     |    |                      |    |                   |
        +------------>|  @vue/runtime-dom   +--->|  @vue/runtime-core   +--->|  @vue/reactivity  |
                      |                     |    |                      |    |                   |
                      +---------------------+    +----------------------+    +-------------------+
```
**å­¦ä¹ è·¯çº¿**

æ ¹æ®æ¨¡å—ä¾èµ–å…³ç³», è·¯çº¿ä¸º: `reactivity` -> `runtime-core` -> `runtime-dom` -> `compiler`. é‡ç‚¹æ˜¯ `runtime-*`

**ä»£ç åˆ†ææ­¥éª¤**:

1. æŸ¥çœ‹å•å…ƒæµ‹è¯•(ä½äº`packages/**/__tests__/`)
2. æ ¹æ®å•å…ƒæµ‹è¯•äº†è§£æ¨¡å—å®ç°çš„åŠŸèƒ½
3. è·Ÿç€å•å…ƒæµ‹è¯•çš„äº†è§£æ¨¡å—åŠŸèƒ½, äº†è§£æ¨¡å—åŠŸèƒ½æ—¶: å…ˆçœ‹å¯¼å‡º(æ¨¡å—æ˜¯ä»€ä¹ˆ), å†çœ‹æ¨¡å—è¢«è°å¯¼å…¥(ä¸ºä»€ä¹ˆè¢«éœ€è¦), æœ€åçœ‹å¯¼å‡ºéƒ¨åˆ†å¯¹åº”çš„å®ç°(æ€ä¹ˆæ ·å®ç°)

**å‚è€ƒ repo**

- [cuixiaorui/mini-vue](https://github.com/cuixiaorui/mini-vue): ç”¨æ¥å­¦ä¹ 
- [vuejs/core](https://github.com/vuejs/core): ç”¨æ¥éªŒè¯

### Reactivity çš„åŸºæœ¬æµç¨‹

`Reactivity` æ¨¡å—æ˜¯è¿è¡Œæ—¶çš„æœ€åº•å±‚, è´Ÿè´£å®ç°å“åº”å¼, ä½äº: `mini-vue/packages/reactivity`

**`reactive` çš„åŸºæœ¬æµç¨‹**

`reactive` æ˜¯ `Reactivity` çš„åŸºç¡€. è´Ÿè´£å®ç°å¯¹è±¡çš„å“åº”å¼, å¹¶å‘ä¸Šæä¾›è°ƒç”¨æ—¶æ–¹æ³•. åŸºæœ¬æ€æƒ³å°±æ˜¯å€ŸåŠ© ES6 çš„ `Proxy` è‡ªå®šä¹‰ `get & set`

1. è½¬åˆ° `mini-vue/../__tests__/reactive.spec.ts`, å‘ç°æµ‹è¯•çš„ä¸»è¦ç›®çš„æ˜¯çœ‹ `reactive` æ„é€ æ–¹æ³•. 

2. è½¬åˆ° `mini-vue/../src/reactive.ts`, å‘ç°å®šä¹‰äº† `reactive`, `readonly` ç­‰æ–¹æ³•, è¿™äº›æ–¹æ³•éƒ½äº¤ç”± `createReactiveObject` å¤„ç†. 

   è§‚å¯Ÿ `createReactiveObject`, å¯ä»¥å¾—åˆ°ä¸‰ä¸ªè°ƒç”¨å‚æ•°æ„ä¹‰:

   - `target`: è¦è¢«ä»£ç†çš„å€¼

   - `proxyMap`: ä¸åŒç±»å‹çš„å·¥å‚å‡½æ•°æœ‰ä¸åŒçš„å…¨å±€ `proxyMap`, è¿™æ„å‘³ç€è¯¥å˜é‡å¯èƒ½ä¼šå­˜å‚¨æ‰€æœ‰ä»£ç†çš„æŸç±»å‹å˜é‡. æ ¹æ®

     ```ts
     const existingProxy = proxyMap.get(target);
     if (existingProxy) {
         return existingProxy;
     }
     ```

     å¯ä»¥éªŒè¯æƒ³æ³•, å…¶åœ¨ `createReactiveObject` çš„ç›®çš„å°±æ˜¯æŒä¹…åŒ– `Proxy` é˜²æ­¢é‡å¤åˆ›å»ºä»£ç†

   - `baseHandlers`: æ ¹æ®

     ```ts
     const proxy = new Proxy(target, baseHandlers);
     ```

     å¾—å‡ºè¯¥æ–¹æ³•å°±æ˜¯ Proxy([MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy)) çš„ `get & set` å¯¹è±¡. ä¸åŒç±»å‹çš„ Proxy æœ‰ä¸åŒçš„ `baseHandlers` 

3. è½¬åˆ° `mini-vue/../src/baseHandlers.ts` å‘ç°æ¨¡å—ä¸»è¦æ˜¯æä¾›ä¸åŒçš„ `get & set` è€Œè¿™äº›éƒ½æ˜¯ç”±ä¸¤ä¸ª `create` å‡½æ•°å®ç°çš„, å°è¯•ç†è§£

   - `createGetter` åº”è¯¥è¿”å›ä¸€ä¸ª `handler.get`([MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get)) å®ç°. å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¸Šæœ‰ä¸€å †ç±»å‹åˆ¤æ–­çš„æ–¹æ³•, ç„¶ååšäº†ä¸¤æ­¥

     - é€šè¿‡ `Reflect.get`([MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect/get)) è·å–å±æ€§
     - é€šè¿‡ `track` è¿›è¡Œ**ä¾èµ–æ”¶é›†**, è¿™éƒ¨åˆ†åé¢å†çœ‹

     æœ€åè¿”å›è·å–ç»“æœ. æ•´ä¸ª `get` æ„Ÿè§‰å’ŒåŸç”Ÿæ–¹æ³•ç›¸æ¯”å°±æ˜¯å¤šäº†ä¸ªç±»å‹åˆ¤æ–­å’Œ `track`, å¤§éƒ¨åˆ†çš„å“åº”å¼éƒ½æ˜¯ä¾èµ–è¿™ä¸ª `track` å®ç°çš„

   - `createSetter` æ›´åŠ ç®€å•, çœ‹èµ·æ¥å°±æ˜¯åœ¨å®ç° `handler.set`([MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set)) çš„åŸºç¡€ä¸Šå¤šäº†ä¸ª `trigger`

   åˆ°ç›®å‰ä½ç½®è¿™ä¸ªåªæœ‰ `track` å’Œ `trigger` æ˜¯ä¸æ¸…æ¥šçš„, è¿™ä¸¤ä¸ªå‡½æ•°åœ¨ `effect` ç­‰éƒ¨åˆ†åšä¾èµ–æ”¶é›†çš„, å¯ä»¥å…ˆä¸ç®¡. å…¶ä»–éƒ¨åˆ†å°±æ˜¯åŸç”ŸåŠŸèƒ½è°ƒç”¨ä¸æƒé™ç®¡ç†

**`effect` çš„åŸºæœ¬æµç¨‹**

å¦‚æœè®©æˆ‘å®ç° `effect` æˆ‘ä¼šæ€ä¹ˆå®ç°å‘¢? æˆ‘å…ˆæƒ³åˆ°çš„æ˜¯åˆ©ç”¨ç¼–è¯‘åŸç†ç­‰é­”æ³•å¯¹ä»£ç åšé™æ€åˆ†æ, æ‰¾åˆ°æ‰€ç”¨å“åº”å¼å¯¹è±¡, åœ¨å“åº”å¼å¯¹è±¡çš„ `set` ä¸ŠæŒ‚ä¸Šå‡½æ•°. ä½†æ˜¯, JavaScript æ˜¯ä¸ªåŠ¨æ€è¯­è¨€, è¿™å®Œå…¨æ²¡æ³•æŒ‚å•Š! åªèƒ½åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æ.

Vue çš„å®ç°å°±æ¯”è¾ƒæµç•…. æ—¢ç„¶æˆ‘ `effect` è¦ç«‹å³æ‰§è¡Œä¸€éå‡½æ•°, é‚£ä¸ºå•¥ä¸åœ¨æ‰§è¡Œå‰ååšä¸‹ Flag, ä¸€æ—¦ Proxy çš„ `get` è¢«è°ƒç”¨, è®© `get` æ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯åœ¨ `effect` æ‰§è¡Œé˜¶æ®µ, è‹¥æ˜¯å°±æŠŠå‡½æ•°æ³¨å†Œåˆ°è¿™ä¸ªå“åº”å¼å¯¹è±¡ä¸ŠğŸ˜

1. è½¬åˆ° `mini-vue/../__tests__/reactive.spec.ts` çœ‹åˆ° `effect` çš„ä¸»è¦åŠŸèƒ½æ˜¯ç«‹å³æ‰§è¡Œå‡½æ•°å¹¶åœ¨å“åº”å¼æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶, å»æ‰§è¡Œ `effect` æ³¨å†Œçš„å‡½æ•°

2. è½¬åˆ° `mini-vue/../src/effect.ts` çœ‹ `effect` å‡½æ•°çš„å®ç°. çœ‹åˆ°è¿™é‡Œæœ‰ç†Ÿæ‚‰çš„ `effect`, `track`, `trigger`

   1. `effect` å‡½æ•°å°†ä¼ å…¥å‡½æ•°åŒ…è£…ä¸º `ReactiveEffect` å¯¹è±¡, åˆå¹¶é…ç½®, æ‰§è¡Œ `run` å‡½æ•°, æ„é€  `runner` å¹¶è¿”å›(ç”¨äºåæœŸè°ƒç”¨)

   2. `ReactiveEffect` ç±»

      - `active`: æ ¹æ® `run`, `stop` å‡½æ•°å’Œæµ‹è¯•æ–‡ä»¶ä¸­çš„ `it("stop")` æ–­è¨€å¯ä»¥æ¨å‡ºå…¶æ˜¯ç”¨æ¥å¼€å…³ `effect` åŠŸèƒ½çš„
      - `deps`: æ ¹æ® `track` ä¸ `trigger` å¯¹å…¶è°ƒç”¨å¯ä»¥åˆ¤æ–­å…¶æ˜¯ç”¨æ¥è®°å½•å‡½æ•°å¯¹åº”ä¾èµ–çš„
      - `run`: å¯¹ `effect` æ³¨å†Œå‡½æ•°çš„åŒ…è£…, åœ¨æ‰§è¡Œå‡½æ•°å‰åæ‰“å…¥ `shouldTrack` æ ‡è®°, å¹¶å°† `activeEffect` æ ‡è®°ä¸ºè¦æ‰§è¡Œçš„ `ReactiveEffect` å¥½è®© `get` çŸ¥é“å“ªä¸ª `effect` åœ¨è·‘

   3. `track` å‡½æ•°: åœ¨ `reactive` çš„ `get` ä¸­è°ƒç”¨

      ```typescript
      track(target, "get", key);
      ```

      `track` å‘ç°è‡ªå·±å¤„äº `effect` é˜¶æ®µæ—¶ä¼šå…ˆæ£€æŸ¥è‡ªå·±æ‰€åœ¨å¯¹è±¡æœ‰æ²¡æœ‰åˆ›å»º `attribute` - `effect` å‡½æ•°heap çš„ `map`, å¦‚æœæ¯å°±åˆ›å»º, ç„¶åçœ‹ `map` ä¸Šæœ‰æ²¡æœ‰è®°å½•å½“å‰å±æ€§, å¦‚æœæ²¡æœ‰, å°±å»ºç«‹ä¾èµ–çš„ `set` å¹¶äº¤ç”± `trackEffects` åŠ å…¥å¹¶åœ¨ `ReactiveEffect` ä¸Šä¹Ÿåšè®°å½•.

   4. `trigger` å‡½æ•°: åœ¨ `reactive` çš„ `set` ä¸­è°ƒç”¨

      å…ˆæ‰¾åˆ°å¯¹åº” `attribute` çš„ `effect` ä¾èµ–, å»é‡, æ ¹æ®é…ç½®å»¶è¿Ÿæˆ–ç«‹å³æ”¯æŒ `effect`

**æ€»ç»“**

- `reactive` çš„æµç¨‹: ä¼ å…¥å¯¹è±¡, æŒä¹…åŒ–, ç»‘å®š `baseHandlers` åšæƒé™ç®¡ç†ä¸ä¾èµ–æ”¶é›†
- `effect` çš„æµç¨‹: å°†ä¼ å…¥å‡½æ•°åŒ…è£…ä¸ºå¯¹è±¡, ç«‹å³æ‰§è¡Œå‡½æ•°å¹¶åšå¥½æ ‡è®°, åœ¨æ‰§è¡Œæ—¶æ”¶é›†ä¾èµ–. æ¯å½“ `reactive` è¢«è°ƒç”¨æ—¶å°± `tigger` æ”¶é›†çš„ `effect`, å¹¶äºŒæ¬¡æ”¶é›†ä¾èµ–

**é—®é¢˜**

- æ‰€æœ‰çš„ä¾èµ–æ”¶é›†éƒ½æ˜¯åŸºäº `get`, è¿™æ ·çš„ `effect` å­˜åœ¨é—®é¢˜

  ```js
  it('should observe basic properties', () => {
    let dummy, flag = false;
    const counter = reactive({ num: 0 });
    effect(() => {
      if (!flag) {
        dummy = -1;
      } else {
        dummy = counter.num;
      }
    });
  
    expect(dummy).toBe(-1);
    flag = true;
    counter.num = 2;
    expect(dummy).toBe(2); // Except 2, Received -1
  });
  ```

  ä¸åªæ˜¯ `mini-vue`, `vue/core` çš„å•å…ƒæµ‹è¯•ä¹Ÿå­˜åœ¨è¿™ä¸ªé—®é¢˜. ä½†æ˜¯åœ¨ `Vue` ä»£ç ä¸­å¹¶ä¸ä¼šå‡ºç°æ— æ³•è¿½è¸ªä¾èµ–çš„é—®é¢˜, çœ‹æ¥è¿˜æœ‰ä¸€äº›éšè—çš„ä¼˜åŒ–æ²¡æœ‰æ‰¾åˆ°

### runtime-core çš„åŸºæœ¬æµç¨‹

